<!-- finance/templates/finance/transaction_container.html -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>



{% load static %}
{% load humanize %}
{% load widget_tweaks %}


<div class="flex flex-col-reverse md:grid md:grid-cols-4 md:gap-4" id="transaction-container">

    <!-- 3/4 cols for the table of transactions -->
    <div class="col-span-3">
        <div class="my-4">
            <h1 class="mt-4 mb-4 prose prose-2xl text-white">Totals</h1>
            <table class="table">
                <thead class="text-xs text-white uppercase">
                    <tr>
                        <th>Total Income</th>
                        <th>Total Expenses</th>
                        <th>Net Income</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${{ total_income|floatformat:2|intcomma }}</td>
                        <td>${{ total_expenses|floatformat:2|intcomma }}</td>
                        <td>${{ net_income|floatformat:2|intcomma }}</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex justify-between items-center mt-4 mb-6">
            <h1 class="mt-8 mb-4 prose prose-2xl text-white">Transactions</h1>

            <!-- Filter Form -->
            <form method="GET" action="{% url 'transaction_container' %}" id="filterform">
                <div class="mb-2 form-control">
                    {{ filter_form.transaction_type|add_label_class:"label text-white" }}
                    {% render_field filter_form.transaction_type class="select bg-gray-50 text-gray-900" %}
                </div>

                <div class="mb-2 form-control">
                    {{ filter_form.start_date|add_label_class:"label text-white" }}
                    {% render_field filter_form.start_date class="input bg-gray-50 text-gray-900" %}
                </div>

                <div class="mb-2 form-control">
                    {{ filter_form.end_date|add_label_class:"label text-white" }}
                    {% render_field filter_form.end_date class="input bg-gray-50 text-gray-900" %}
                </div>

                <div class="mb-4 form-control">
                    {{ filter_form.category|add_label_class:"label text-white" }}
                    {% render_field filter_form.category class="text-green-500 border-gray-300 rounded focus:ring-green-500" %}
                </div>

                <button class="btn btn-success">Filter</button>
            </form>

            {% if transactions %}
            <table class="table">
                <thead class="text-xs text-white uppercase">
                    <tr>
                        <th class="px-6 py-3">Date</th>
                        <th class="px-6 py-3">Category</th>
                        <th class="px-6 py-3">Type</th>
                        <th class="px-6 py-3">Amount</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.date }}</td>
                        <td>{{ transaction.category }}</td>
                        <td>{{ transaction.type }}</td>
                        <td>{{ transaction.amount }}</td>
                        <td class="flex items-center">
                            <a href="{% url 'edit_transaction' transaction.id %}" class="cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 mr-1">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                </svg>
                            </a>
                            <a href="{% url 'delete_transaction' transaction.id %}" class="cursor-pointer" onclick="return confirm('Are you sure you want to delete this transaction?');">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-2xl text-white">No transactions found</p>
            {% endif %}
        </div>
    </div>

    <!-- 1/4 cols for the filter form -->
    <div class="col-span-1">
        <!-- Filter form included in the main content above -->
    </div>
</div>

<span id="spinner" class="loading loading-spinner loading-lg" style="display:none;"></span>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle dynamic form submission (filter form)
        const filterForm = document.getElementById('filterform');
        filterForm.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission
            const formData = new FormData(filterForm);
            const queryString = new URLSearchParams(formData).toString();

            fetch(filterForm.action + '?' + queryString, {
                method: 'GET',
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('transaction-container').outerHTML = html;
            })
            .catch(error => console.error('Error:', error));
        });

        // Dynamic content loading for the Create Transaction link
        document.querySelectorAll('a[href*="create-transaction"]').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                fetchContent(this.href, '#transaction-block');
            });
        });

        // Dynamic content loading for the Export button
        document.querySelectorAll('a[href*="export"]').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                fetchContent(this.href);
            });
        });

        // Dynamic content loading for the Import button
        document.querySelectorAll('a[href*="import"]').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                fetchContent(this.href, '#transaction-block');
            });
        });

        // Delete confirmation and AJAX delete request
        document.querySelectorAll('a[href*="delete-transaction"]').forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                if (confirm('Are you sure you want to delete this transaction?')) {
                    fetch(this.href, { method: 'DELETE' })
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('transaction-container').outerHTML = html;
                    })
                    .catch(error => console.error('Error:', error));
                }
            });
        });

        // Function to dynamically load content via AJAX
        function fetchContent(url, targetId = null) {
            fetch(url)
            .then(response => response.text())
            .then(html => {
                if (targetId) {
                    document.querySelector(targetId).innerHTML = html;
                } else {
                    document.body.innerHTML = html;
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
</script>
</body>
</html>
